{% extends "base.html" %}

{% block container %}
<main class="main" role="main">
    <section id="content" class="my-account">
        <div class="row title">
            <div class="columns">
                <h1>Hello, {% if request.user.name %}{{ request.user.name }}{% else %}{{ request.user.email }}{% endif %}</h1>
                <div class="buttons">
                    <a href="{% url 'account_update' %}" class="button primary">Edit Account Info</a>
                </div>
                {% if request.user.postcode %}<p>Your postcode: <strong>{{ request.user.postcode }}</strong></p>{% endif %}
                <p id="your_last_search" style="display:none">Your last search: <strong><a id="last_search_link"></a></strong></p>
            </div>
        </div>
    </section>
    <section id="my_account">
        {% if request.user.is_staff %}
            {% include 'account/partials/admin_menu.html' %}
        {% endif %}
        <div class="row my-account-links">
            <div class="columns s-3 m-3 l-3">
                {% with url_name=request.resolver_match.url_name %}
                <a href="{% url 'account_saved_services' %}" {% if url_name == 'account_saved_services' %}class="active"{% endif %}>
                    <span class="text">
                        My Saved Services
                    </span>
                </a>
            </div>
            <div class="columns s-3 m-3 l-3">
                <a href="{% url 'account_my_recommendations' %}" {% if url_name == 'account_my_recommendations' or url_name == 'account_my_recommendations_detail' %}class="active"{% endif %}>
                    <span class="text">
                        My Recommendations
                    </span>
                </a>
            </div>
            <div class="columns s-3 m-3 l-3">
                <a href="{% url 'account_my_organisations' %}" {% if url_name == 'account_my_organisations' or url_name == 'claim_create' %}class="active"{% endif %}>
                    <span class="text">
                        My Organisations
                    </span>
                </a>
            </div>
            <div class="columns s-3 m-3 l-3">
              <!--Need to add the code to link the digest view to detail view etc.  -->
                <a href="{% url 'account_my_digest'%}" {% if url_name == 'account_my_digest'%}class="active"{% endif %}>
                    <span class="text">
                        My Digest
                    </span>
                </a>
                {% endwith %}
            </div>
        </div>
        <hr class = "clear"/>
        <div class="row">
            <div class="columns">
            {% block content %}
            {% endblock %}
            </div>
        </div>
    </section>
    <section class="mobile-buttons">
        <div class="row">
            <div class="columns">
                <a href="{% url 'account_update' %}" class="button primary">Edit Account Info</a>
                <a href="{% url 'logout' %}" class="button secondary">Logout</a>
            </div>
        </div>
    </section>
</main>
{% endblock %}


{% block before_body_close %}
  <script type="text/javascript">
    $(document).ready(function(){
      searchURL = localStorage.getItem('searchURL')
      var hash = {}
      if (searchURL != null){
        query_section = searchURL.split('?')
        query_section = query_section[1]
        query_section = query_section.replace(/\+/gi, " ")
        query_section = query_section.replace(/-/gi, " ")
        query_section = query_section.split('&')
        query_section.every(function(query){
          query_pair = query.split("=")
          if (query_pair[1] != "") {

            if (query_pair[1].includes(" ")){
              query_pair[1] = query_pair[1].trim()
              uncapped_words = query_pair[1].split(" ")
              capped_words = uncapped_words.map(function(word){
                if (word == "and") {
                  return word
                }
                else {
                word =  word[0].toUpperCase() + word.slice(1)
                return word
                }
              })
              capped_words = capped_words.join(" ")
              hash[query_pair[0]] = capped_words
            }
          else {
            hash[query_pair[0]] = query_pair[1][0].toUpperCase() + query_pair[1].slice(1)
            }
        }
          return hash
        })
        last_search_string = hash['postcode']
        if (hash['category']){
          last_search_string = last_search_string + " and \"" + hash['category'] + "\""
        }
        if (hash['q']){
          last_search_string = last_search_string + " for \"" + hash['q'] + "\""
        }
      $('#last_search_link').attr('href', searchURL)
      $('#last_search_link').text(last_search_string)
      $('#your_last_search').show()
      }
    })
  </script>
{% endblock%}
