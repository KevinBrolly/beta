{% extends "base.html" %}
{% load aliss %}
{% load humanize %}

{% block container %}
<main class="main" role="main">
    {% if not invalid_area and not errors %}
        <section id="content" class="results">
            <div class="row title">
                <div class="columns">
                    <h1>Help &amp; Support in <span class="postcode">{{ postcode.postcode }}</span></h1>
                    <div class="buttons">
                        <a href="{% url 'homepage' %}" class="button primary">Search Again</a>
                    </div>
                </div>
            </div>
        </section>
        <section id="results">
            <div class="row category-selector">
                <div class="columns">
                    <h4 class="toggle-heading" id="select_cat_toggle">Select Category</h4>

                    <!-- ONE -->
                    {% if not category %}
                        <div class="cells one toggled" id="select_cat">
                            <ul>
                                <li>
                                    <a class="select-category">Select Category</a>
                                    <span class="select"></span>
                                    <ul class="cat-icons">
                                        {% get_categories as categories %}
                                        {% for category in categories %}
                                            {% if category.is_root %}
                                                <li{% if category.slug == request.GET.category %} class='active'{% endif %}>
                                                    <a href="?{% query_transform request category=category.slug page=None %}">
                                                        <span class="cat">
                                                            <i class="fa {{ category|get_icon }}"></i>
                                                        </span>
                                                        <span class="name">
                                                            {{ category.name }}
                                                        </span>
                                                    </a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    {% else %}
                        {% get_category_tree category=category as category_tree %}
                        {% if category.children.all %}
                            <div class="cells {{ category_tree|length|add:1|apnumber }} toggled" id="select_cat">
                        {% else %}
                            <div class="cells {{ category_tree|length|apnumber }} toggled" id="select_cat">
                        {% endif %}
                            <ul>
                                {% for item in category_tree %}
                                    <li>
                                        {% if item.is_root %}
                                            <a href="#" class="active-cat icon truncate">
                                                <span class="cat">
                                                    <i class="fa {{ item|get_icon }}"></i>
                                                </span>
                                                <span class="name">
                                                    {{ item.name }}
                                                </span>
                                            </a>
                                        {% else %}
                                            <a href="?{% query_transform request category=item.slug page=None %}" class="active-cat truncate">{{ item.name }}</a>
                                        {% endif %}
                                        <span class="select"></span>
                                        <ul {% if category.is_root %}class="cat-icons"{% endif %}>
                                            {% for sibling in item.siblings %}
                                                {% if sibling.is_root %}
                                                    <li{% if sibling.pk == item.pk %} class="active"{% endif %}>
                                                        <a href="?{% query_transform request category=sibling.slug page=None %}">
                                                            <span class="cat">
                                                                <i class="fa {{ sibling|get_icon }}"></i>
                                                            </span>
                                                            <span class="name">
                                                                {{ sibling.name }}
                                                            </span>
                                                        </a>
                                                    </li>
                                                {% else %}
                                                    <li{% if sibling.pk == item.pk %} class="active"{% endif %}><a href="?{% query_transform request category=sibling.slug page=None %}">{{ sibling.name }}</a></li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </li>
                                    {% if forloop.last %}
                                        {% if item.children.all %}
                                            <li>
                                                <a href="#" class="select-category">Select Sub Category</a>
                                                <span class="select"></span>
                                                <ul>
                                                    {% for child in item.children.all %}
                                                        <li><a href="?{% query_transform request category=child.slug page=None %}">{{ child.name }}</a></li>
                                                    {% endfor %}
                                                </ul>
                                            </li>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                        <p><a href="?{% query_transform request category=None page=None %}" class="clear">Clear Categories</a></p>
                    {% endif %}
                </div>
            </div>
            <div class="row results">
                <div class="columns filters">
                    <h4 class="toggle-heading" id="filters_toggle">Customise Results</h4>
                    <div class="filter-group toggled" id="filters">
                        <form>
                            <div class="filter keyword-search">
                                <label>Filter by keyword:</label>
                                <div class="sbs-inputs">
                                    <input type="text" placeholder="e.g. Diabetes" name="q" value="{{ request.GET.q }}">
                                    <input type="hidden" name="location_type" value="{{ request.GET.location_type }}">
                                    <input type="hidden" name="postcode" value="{{ request.GET.postcode }}">
                                    <input type="hidden" name="category" value="{{ request.GET.category }}">
                                    <input type="submit" class="secondary" value="Search">
                                </div>
                            </div>
                        </form>
                        <div class="filter category">
                            <label>Filter by proximity:</label>
                            <ul class="radio-list-links">
                                <li  {% if not request.GET.location_type %}class="active"{% endif %}>
                                    <a href="?{% query_transform request location_type=None %}">
                                        <span class="radio"></span>
                                        <span class="name">
                                            Show me all services, local and national
                                        </span>
                                    </a>
                                </li>
                                <li {% if request.GET.location_type == 'point' %}class="active"{% endif %}>
                                    <a href="?{% query_transform request location_type='point' %}">
                                        <span class="radio"></span>
                                        <span class="name">
                                            Only show the services that operate locally
                                        </span>
                                    </a>
                                </li>
                                <li {% if request.GET.location_type == 'area' %}class="active"{% endif %}>
                                    <a href="?{% query_transform request location_type='area' %}">
                                        <span class="radio"></span>
                                        <span class="name">
                                            Only show services that operate nationally
                                        </span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="columns listing">
                    {% if object_list %}
                        <ul class="search-results">
                            {% for result in object_list %}
                                <li>
                                    <div class="heading">
                                        <a href="{% url 'service_report_problem' result.id %}" class="alert icon-link">
                                            <span class="icon">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </span>
                                            Report this listing
                                        </a>
                                        <a href="{% url 'service_detail' result.id %}"><h3>{{ result.name }}</h3></a>
                                    </div>
                                    <p class="org">by <a href="{% url 'organisation_detail' result.organisation.id %}">{{ result.organisation.name }}</a> {% if result.claimed_by %}<span class="claimed">Claimed</span>{% endif %}</p>
                                    <p>{{ result.description|linebreaks|truncatechars:150 }}</p>
                                    <div class="assigned-category">
                                        {% for category in result.categories %}
                                            <a href="?{% query_transform request category=category.slug %}">
                                                {{ category.name }}
                                            </a>
                                            {% if not forloop.last %},{% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="location multiple">
                                        <div class="locations-list active">
                                            {% for location in result.locations %}
                                                <a class="icon-link">
                                                    <span class="icon">
                                                        <i class="fas fa-map-marker-alt"></i>
                                                    </span>
                                                    {{ location.formatted_address }}
                                                </a>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <ul class="contact-info">
                                        {% if result.phone %}
                                            <li>
                                                {{ result.phone }}
                                            </li>
                                        {% endif %}
                                        {% if result.url %}
                                            <li>
                                                <a href="{{ result.url }}">Website</a>
                                            </li>
                                        {% endif %}
                                        {% if result.service_areas %}
                                            <li class="service-areas">
                                                <a>Service Areas</a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                    {% if result.service_areas %}
                                        <div class="service-areas-list">
                                            <p>{% for area in result.service_areas %}{{ area.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
                                        </div>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="error">
                            <div class="copy-container">
                                <h2>Sorry, we couldn't find anything using those terms.</h2>
                                <p>You can try again or start a fresh search below:</p>
                            </div>
                            <div class="buttons">
                                <a href="{% url 'homepage' %}" class="button primary">Search again</a>
                            </div>
                        </div>
                    {% endif %}
                    {% include 'partials/pagination.html' with page=page_obj paginator=paginator %}
                </div>
            </div>
        </section>
        {% include 'partials/share-search.html' %}
    {% else %}
        {% if invalid_area %}
            <section id="error">
                <div class="row">
                    <div class="columns">
                        <div class="copy-container">
                            <h1>Sorry, ALISS is not available in your postcode.</h1>
                            <p>We're always adding new services to ALISS but it seems like we've not reached your area yet. Please try again with a different postcode:</p>
                        </div>
                        <div class="buttons">
                            <a href="{% url 'homepage' %}" class="button primary">Search again</a>
                        </div>
                    </div>
                </div>
            </section>
        {% endif %}
                {% if errors %}
                    {% for error in errors %}
                        {% if error == 'postcode' %}
                            <section id="error">
                                <div class="row">
                                    <div class="columns">
                                        <div class="copy-container">
                                            <h1>Sorry, {{ request.GET.postcode }} doesn't appear to be a valid postcode.</h1>
                                            <p>The postcode you entered seems to be in the wrong format, please try again:</p>
                                        </div>
                                        <div class="buttons">
                                            <a href="{% url 'homepage' %}" class="button primary">Search again</a>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    {% endif %}
</main>
{% endblock %}
